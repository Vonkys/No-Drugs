<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KratomTime</title>
  <style>
    :root {
      --bg: #0f172a;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --accent: #22c55e;
      --accent-hover: #16a34a;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
      --g2: #22c55e;
      --g3: #eab308;
      --g4: #f97316;
      --g5: #ef4444;
      --g6: #a855f7;
      --g0: #94a3b8;
    }
    body { margin:0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    .header { display:flex; justify-content: space-between; align-items:center; gap:12px; }
    .title { font-weight: 700; font-size: 24px; }
    .card { background: #111827; border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow); margin-bottom:16px; }
    .btns { display:flex; gap: 8px; flex-wrap: wrap; }
    button { cursor:pointer; border:none; border-radius:8px; padding:10px 14px; font-weight:600; }
    .primary { background: var(--accent); color:#0b1220; }
    .primary:hover { background: var(--accent-hover); }
    .ghost { background: rgba(255,255,255,.1); color: var(--text); }
    .danger { background: var(--danger); color:white; }
    .danger:hover { background: var(--danger-hover); }
    input[type="number"], input[type="text"], input[type="date"], input[type="time"] {
      background: rgba(255,255,255,.08); color: var(--text); border: 1px solid rgba(255,255,255,.12); border-radius: 10px; padding: 8px 10px;
    }
    table { width:100%; border-collapse: collapse; }
    th,td { padding:8px 8px; border-bottom:1px solid rgba(255,255,255,.1); text-align:left; }
    th { color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.06em; }
    .gchip { display:inline-block; min-width:36px; text-align:center; padding:2px 6px; border-radius:6px; font-weight:700; }
    .g2{background:var(--g2);} .g3{background:var(--g3);} .g4{background:var(--g4);} .g5{background:var(--g5);color:#fff;} .g6{background:var(--g6);color:#fff;} .g0{background:var(--g0);}    
    .del { line-height:1; padding:6px 10px; }
    dialog { border:none; border-radius:12px; padding:20px; background:#1f2937; color:var(--text); }
    dialog::backdrop { background:rgba(0,0,0,.5); }
    canvas { width:100%; background:#0b1220; border-radius:12px; display:block; }

    /* Seskupené dny */
    details.day { border:1px solid rgba(255,255,255,.08); border-radius:12px; margin:8px 0; }
    details.day summary { cursor:pointer; list-style:none; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    details.day summary::-webkit-details-marker { display:none; }
    .day-meta { color: var(--muted); font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">KratomTime</div>
    <div id="todayBadge">—</div>
  </div>

  <section class="card">
    <h3>Přidat záznam</h3>
    <div class="btns">
      <button class="primary" data-preset="2">2 g</button>
      <button class="primary" data-preset="2.3">2.3 g</button>
      <button class="primary" data-preset="2.4">2.4 g</button>
      <button class="primary" data-preset="2.5">2.5 g</button>
    </div>
    <div class="btns" style="margin-top:8px;">
      <input id="customAmount" type="number" step="0.1" min="0.1" placeholder="g" style="width:90px;">
      <input id="note" type="text" placeholder="poznámka" style="flex:1; min-width:180px;">
      <button id="addCustom" class="primary">Přidat</button>
    </div>
    <div class="btns" style="margin-top:8px;">
      <button id="backfillBtn" class="danger">Zpětný záznam</button>
    </div>
    <div style="margin-top:8px; font-size:14px; color:var(--muted);">
      Dnes: <span id="totalToday">0</span> g • záznamů: <span id="countToday">0</span>
    </div>
  </section>

  <!-- graf nad záznamy -->
  <section class="card">
    <h3>Graf dávkování</h3>
    <div class="btns" style="margin-bottom:8px;">
      <label for="chartMode" style="color:#9ca3af;">Režim:</label>
      <select id="chartMode" style="background:#0b1220; color:#e5e7eb; border:1px solid rgba(255,255,255,.12); border-radius:8px; padding:6px 8px;">
  <option value="dailyTotals" selected>Denní součty (30 dní)</option>
  <option value="monthlyTotals">Posledních 6 měsíců</option>
  </select>
 </div>
    <canvas id="doseChart" height="220"></canvas>
  </section>

  <section class="card">
    <h3>Všechny záznamy</h3>
    <!-- nově místo jediné tabulky: skládací dny -->
    <div id="groups"></div>
  </section>
</div>

<dialog id="backfillDlg">
  <h3>Zpětný záznam</h3>
  <div class="btns" style="margin-bottom:8px;">
    <button type="button" data-bf="2">2 g</button>
    <button type="button" data-bf="2.3">2.3 g</button>
    <button type="button" data-bf="2.4">2.4 g</button>
    <button type="button" data-bf="2.5">2.5 g</button>
  </div>
  <div class="btns" style="flex-direction:column; gap:6px;">
    <input id="bfAmount" type="number" step="0.1" placeholder="g">
    <input id="bfDate" type="date">
    <input id="bfTime" type="time" step="60">
    <input id="bfNote" type="text" placeholder="poznámka">
  </div>
  <div class="btns" style="margin-top:10px;">
    <button id="bfCancel">Zavřít</button>
    <button id="bfSave" class="primary">Uložit</button>
  </div>
</dialog>

<script>
/* ===== HELPERY ===== */
function pad(n){return String(n).padStart(2,'0');}
function dateKey(d=new Date()){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}
function fmtDate(d){return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;}
function fmtTime(d){return pad(d.getHours())+':'+pad(d.getMinutes());}
function isoLocal(d){
  const tz=d.getTimezoneOffset();
  return new Date(d.getTime()-tz*60000).toISOString().slice(0,19);
}
function escapeHtml(str){
  return String(str).replace(/[&<>\"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m]));
}
function genId(){
  return Date.now().toString(36)+Math.random().toString(36).slice(2,8);
}

/* ===== STORAGE + FIREBASE ===== */
const STORAGE_KEY='gramLog-all';
const FIREBASE_URL='https://kratom-332d6-default-rtdb.europe-west1.firebasedatabase.app';
const BASELINE_G = 15;

function loadAll(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }
  catch{ return []; }
}
function saveAll(list){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(list));
}

let entries = loadAll();

/* ===== FIREBASE ===== */
function sendToFirebase(entry){
  try{
    const payload={
      ts: Math.round(new Date(entry.ts).getTime()/1000),
      g: Number(entry.g),
      source:'web',
      note: entry.note || ''
    };
    fetch(FIREBASE_URL+'/logs.json',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    }).catch(()=>{});
  }catch(e){
    console.error('Firebase send error',e);
  }
}

async function syncFromFirebase(){
  try{
    const res=await fetch(FIREBASE_URL+'/logs.json');
    if(!res.ok) return;
    const data=await res.json();
    if(!data) return;

    const fb=[];
    for(const [k,v] of Object.entries(data)){
      if(!v.ts || !v.g) continue;
      const d=new Date(v.ts*1000);
      fb.push({
        id:'fb-'+k,
        ts: isoLocal(d),
        g: Number(v.g),
        note: v.note || ''
      });
    }

    const seen=new Set();
    entries=[...entries,...fb].filter(e=>{
      const k=e.g+'|'+e.ts+'|'+(e.note||'');
      if(seen.has(k)) return false;
      seen.add(k);
      return true;
    });

    saveAll(entries);
  }catch(e){
    console.error('Firebase sync failed',e);
  }
}

/* ===== UI REFS ===== */
const groupsEl=document.getElementById('groups');
const totalTodayEl=document.getElementById('totalToday');
const countTodayEl=document.getElementById('countToday');
const todayBadge=document.getElementById('todayBadge');
const customAmount=document.getElementById('customAmount');
const noteInput=document.getElementById('note');

/* ===== HEADER ===== */
function refreshHeader(){
  const now=new Date();
  const days=['Ne','Po','Út','St','Čt','Pá','So'];
  todayBadge.textContent=`${days[now.getDay()]} • ${dateKey(now)}`;
}
function gClass(g){
  const r=Math.round(Number(g));
  return r===2?'g2':r===3?'g3':r===4?'g4':r===5?'g5':r===6?'g6':'g0';
}

/* ===== CORE ===== */
function addEntry(grams, when=new Date(), note=''){
  const g=Number(grams);
  if(!g||g<=0) return;

  const entry={
    id: genId(),
    ts: isoLocal(when),
    g,
    note: note.trim()
  };

  entries.push(entry);
  saveAll(entries);
  sendToFirebase(entry);

  render();
  drawChart();
}

/* ===== RENDER ===== */
function render(){
  refreshHeader();
  const today=dateKey(new Date());
  const todays=entries.filter(e=>e.ts.slice(0,10)===today);
  const sumToday=todays.reduce((a,b)=>a+Number(b.g),0);
  totalTodayEl.textContent=sumToday.toLocaleString('cs-CZ',{maximumFractionDigits:2});
  countTodayEl.textContent=todays.length;

  const map=new Map();
  entries.slice().sort((a,b)=>new Date(a.ts)-new Date(b.ts)).forEach(e=>{
    const k=e.ts.slice(0,10);
    if(!map.has(k)) map.set(k,[]);
    map.get(k).push(e);
  });

  groupsEl.innerHTML='';
  [...map.keys()].sort((a,b)=>a<b?1:-1).forEach(dayKey=>{
    const list=map.get(dayKey);
    const details=document.createElement('details');
    details.className='day';
    if(dayKey===today) details.open=true;

    const daySum=list.reduce((a,b)=>a+Number(b.g),0).toLocaleString('cs-CZ',{maximumFractionDigits:2});
    const summary=document.createElement('summary');
    summary.innerHTML=`<div>${fmtDate(new Date(list[0].ts))}</div>
      <div class="day-meta">součet: <strong>${daySum} g</strong> • záznamů: ${list.length}</div>`;
    details.appendChild(summary);

    const tbl=document.createElement('table');
    tbl.innerHTML='<thead><tr><th>Čas</th><th>g</th><th>Poznámka</th><th></th></tr></thead><tbody></tbody>';
    const tb=tbl.querySelector('tbody');

    list.forEach(e=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${fmtTime(new Date(e.ts))}</td>
        <td><span class="gchip ${gClass(e.g)}">${Number(e.g).toLocaleString('cs-CZ',{maximumFractionDigits:2})}</span></td>
        <td>${escapeHtml(e.note)}</td>
        <td><button class="ghost row-del" data-id="${e.id}">×</button></td>`;
      tb.appendChild(tr);
    });

    details.appendChild(tbl);
    groupsEl.appendChild(details);
  });
}

/* ===== DELETE ===== */
groupsEl.addEventListener('click',ev=>{
  const btn=ev.target.closest('.row-del');
  if(!btn) return;
  const id=btn.dataset.id;
  if(confirm('Smazat tento záznam?')){
    entries=entries.filter(e=>e.id!==id);
    saveAll(entries);
    render();
    drawChart();
  }
});

/* ===== BACKFILL ===== */
const backfillBtn=document.getElementById('backfillBtn');
const backfillDlg=document.getElementById('backfillDlg');
const bfAmount=document.getElementById('bfAmount');
const bfDate=document.getElementById('bfDate');
const bfTime=document.getElementById('bfTime');
const bfNote=document.getElementById('bfNote');

document.querySelectorAll('[data-bf]').forEach(b=>{
  b.addEventListener('click',()=>bfAmount.value=b.dataset.bf);
});

backfillBtn.addEventListener('click',()=>{
  const now=new Date();
  bfDate.value=now.toISOString().slice(0,10);
  bfTime.value=`${pad(now.getHours())}:${pad(now.getMinutes())}`;
  bfAmount.value=customAmount.value||'';
  bfNote.value=noteInput.value||'';
  backfillDlg.showModal();
});

document.getElementById('bfCancel').addEventListener('click',()=>backfillDlg.close());
document.getElementById('bfSave').addEventListener('click',()=>{
  if(!bfDate.value){alert('Zadej datum');return;}
  const [Y,M,D]=bfDate.value.split('-').map(Number);
  const [H,Min]=(bfTime.value||'00:00').split(':').map(Number);
  const when=new Date(Y,M-1,D,H||0,Min||0);
  addEntry(bfAmount.value,when,bfNote.value);
  backfillDlg.close();
});

/* ===== GRAF ===== */
function dailyTotals(days=30){
  const map=new Map();
  entries.forEach(e=>{
    const d=e.ts.slice(0,10);
    map.set(d,(map.get(d)||0)+Number(e.g));
  });
  const out=[]; const now=new Date();
  for(let i=days-1;i>=0;i--){
    const d=new Date(now.getFullYear(),now.getMonth(),now.getDate()-i);
    const k=dateKey(d);
    out.push({label:`${pad(d.getDate())}.${pad(d.getMonth()+1)}`,val:map.get(k)||0});
  }
  return out;
}

function drawChart(){
  const c=document.getElementById('doseChart');
  const ctx=c.getContext('2d');
  const W=c.width=c.clientWidth, H=c.height;
  ctx.clearRect(0,0,W,H);

  const data=dailyTotals(30);
  const max=Math.max(BASELINE_G,...data.map(d=>d.val),5);
  const left=36,right=8,top=12,bottom=28;
  const iw=W-left-right, ih=H-top-bottom;

  ctx.strokeStyle='rgba(255,255,255,.25)';
  ctx.beginPath();
  ctx.moveTo(left,top);
  ctx.lineTo(left,H-bottom);
  ctx.lineTo(W-right,H-bottom);
  ctx.stroke();

  ctx.strokeStyle='#22c55e';
  ctx.beginPath();
  data.forEach((d,i)=>{
    const x=left+(i/(data.length-1))*iw;
    const y=top+ih-(d.val/max)*ih;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

/* ===== EVENTS ===== */
document.querySelectorAll('[data-preset]').forEach(b=>{
  b.addEventListener('click',()=>customAmount.value=b.dataset.preset);
});
document.getElementById('addCustom').addEventListener('click',()=>{
  addEntry(customAmount.value,new Date(),noteInput.value);
  customAmount.value=''; noteInput.value='';
});

/* ===== INIT ===== */
async function init(){
  await syncFromFirebase();
  render();
  drawChart();
}
init();
</script>
</body>
</html>





