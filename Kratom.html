<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KratomTime</title>

<style>
:root{
  --bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#9ca3af;
  --accent:#22c55e;--accent2:#16a34a;--danger:#ef4444;
  --radius:16px;--shadow:0 10px 25px rgba(0,0,0,.35);
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.wrap{max-width:1100px;margin:32px auto;padding:0 16px}
.header{display:flex;justify-content:space-between;align-items:center}
.title{font-size:24px;font-weight:800}
.card{background:var(--panel);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);margin-bottom:16px}
.btns{display:flex;gap:8px;flex-wrap:wrap}
button{cursor:pointer;border:none;border-radius:10px;padding:10px 14px;font-weight:700}
.primary{background:var(--accent);color:#06240f}
.primary:hover{background:var(--accent2)}
.ghost{background:rgba(255,255,255,.1);color:var(--text)}
.danger{background:var(--danger);color:#fff}
input{background:rgba(255,255,255,.08);color:var(--text);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.1)}
th{color:var(--muted);font-size:12px;text-transform:uppercase}
details.day{border:1px solid rgba(255,255,255,.08);border-radius:12px;margin:8px 0}
details.day summary{cursor:pointer;list-style:none;padding:10px 12px;display:flex;justify-content:space-between}
details.day summary::-webkit-details-marker{display:none}
canvas{width:100%;background:#0b1220;border-radius:12px}
</style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div class="title">KratomTime</div>
    <div id="todayBadge">—</div>
  </div>

  <section class="card">
    <h3>Přidat dávku</h3>
    <div class="btns">
      <button class="primary" data-preset="2">2 g</button>
      <button class="primary" data-preset="2.2">2.2 g</button>
      <button class="primary" data-preset="2.4">2.4 g</button>
      <button class="primary" data-preset="2.6">2.6 g</button>
    </div>

    <div class="btns" style="margin-top:8px">
      <input id="customAmount" type="number" step="0.1" placeholder="g" style="width:80px">
      <input id="note" type="text" placeholder="poznámka" style="flex:1">
      <button id="addBtn" class="primary">Přidat</button>
    </div>

    <div style="margin-top:8px;color:var(--muted)">
      Dnes: <strong id="todayTotal">0</strong> g • záznamů: <strong id="todayCount">0</strong>
    </div>
  </section>

  <section class="card">
    <h3>Graf (30 dní)</h3>
    <canvas id="chart" height="220"></canvas>
  </section>

  <section class="card">
    <h3>Záznamy</h3>
    <div id="groups"></div>
  </section>
</div>

<script>
/* ===== Pomocné ===== */
function pad(n){return String(n).padStart(2,'0')}
function dateKey(d=new Date()){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())}
function fmtDate(d){return pad(d.getDate())+'.'+pad(d.getMonth()+1)+'.'+d.getFullYear()}
function fmtTime(d){return pad(d.getHours())+':'+pad(d.getMinutes())}
function isoLocal(d){const tz=d.getTimezoneOffset();return new Date(d.getTime()-tz*60000).toISOString().slice(0,19)}
function escapeHtml(s){return String(s||'').replace(/[&<>\"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m]))}
function genId(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}

/* ===== Storage + Firebase ===== */
const STORAGE_KEY='kratom-entries-v1';
const FIREBASE_URL='https://kratom-332d6-default-rtdb.europe-west1.firebasedatabase.app';

function loadAll(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return[]}}
function saveAll(list){localStorage.setItem(STORAGE_KEY,JSON.stringify(list))}

let entries=loadAll();

/* ===== Firebase ===== */
function sendToFirebase(entry){
  try{
    const payload={
      ts:Math.round(new Date(entry.ts).getTime()/1000),
      g:entry.g,
      source:'web',
      note:entry.note||''
    };
    fetch(FIREBASE_URL+'/logs.json',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    }).catch(()=>{});
  }catch(e){console.error(e)}
}

async function syncFromFirebase(){
  try{
    const res=await fetch(FIREBASE_URL+'/logs.json');
    if(!res.ok)return;
    const data=await res.json();
    if(!data)return;

    const fb=[];
    for(const [k,v] of Object.entries(data)){
      if(!v.ts||!v.g)continue;
      const d=new Date(v.ts*1000);
      fb.push({
        id:'fb-'+k,
        ts:isoLocal(d),
        g:Number(v.g),
        note:v.note||''
      });
    }

    const seen=new Set();
    entries=[...entries,...fb].filter(e=>{
      const k=e.g+'|'+e.ts+'|'+(e.note||'');
      if(seen.has(k))return false;
      seen.add(k);return true;
    });

    saveAll(entries);
  }catch(e){console.error(e)}
}

/* ===== UI ===== */
const groupsEl=document.getElementById('groups');
const todayBadge=document.getElementById('todayBadge');
const todayTotal=document.getElementById('todayTotal');
const todayCount=document.getElementById('todayCount');
const customAmount=document.getElementById('customAmount');
const noteInput=document.getElementById('note');

function refreshHeader(){
  const d=new Date();const days=['Ne','Po','Út','St','Čt','Pá','So'];
  todayBadge.textContent=days[d.getDay()]+' • '+dateKey(d);
}

function addEntry(g,when=new Date(),note=''){
  g=Number(g);if(!g||g<=0)return;
  const e={id:genId(),ts:isoLocal(when),g,note:note.trim()};
  entries.push(e);saveAll(entries);sendToFirebase(e);
  render();drawChart();
}

document.querySelectorAll('[data-preset]').forEach(b=>{
  b.onclick=()=>customAmount.value=b.dataset.preset;
});
document.getElementById('addBtn').onclick=()=>{
  addEntry(customAmount.value,new Date(),noteInput.value);
  customAmount.value='';noteInput.value='';
};

/* ===== Render ===== */
function render(){
  refreshHeader();
  const today=dateKey();
  const todays=entries.filter(e=>e.ts.slice(0,10)===today);
  todayTotal.textContent=todays.reduce((a,b)=>a+b.g,0).toFixed(1);
  todayCount.textContent=todays.length;

  const map=new Map();
  entries.sort((a,b)=>a.ts>b.ts?1:-1).forEach(e=>{
    const k=e.ts.slice(0,10);
    if(!map.has(k))map.set(k,[]);
    map.get(k).push(e);
  });

  groupsEl.innerHTML='';
  [...map.keys()].reverse().forEach(day=>{
    const list=map.get(day);
    const det=document.createElement('details');
    det.className='day';if(day===today)det.open=true;
    const sum=list.reduce((a,b)=>a+b.g,0).toFixed(1);
    det.innerHTML=`<summary>${fmtDate(new Date(list[0].ts))} • ${sum} g</summary>`;
    const tbl=document.createElement('table');
    tbl.innerHTML='<thead><tr><th>Čas</th><th>g</th><th>Poznámka</th></tr></thead><tbody></tbody>';
    const tb=tbl.querySelector('tbody');
    list.forEach(e=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${fmtTime(new Date(e.ts))}</td><td>${e.g}</td><td>${escapeHtml(e.note)}</td>`;
      tb.appendChild(tr);
    });
    det.appendChild(tbl);
    groupsEl.appendChild(det);
  });
}

/* ===== Graf ===== */
const chart=document.getElementById('chart');
const ctx=chart.getContext('2d');

function drawChart(){
  const W=chart.width=chart.clientWidth,H=chart.height;
  ctx.clearRect(0,0,W,H);
  const days=[...Array(30)].map((_,i)=>{
    const d=new Date();d.setDate(d.getDate()-29+i);
    const k=dateKey(d);
    return {label:pad(d.getDate())+'.'+pad(d.getMonth()+1),
      v:entries.filter(e=>e.ts.slice(0,10)===k).reduce((a,b)=>a+b.g,0)};
  });
  const max=Math.max(5,...days.map(d=>d.v));
  const left=40,right=10,top=10,bottom=25;
  const iw=W-left-right,ih=H-top-bottom;

  ctx.strokeStyle='rgba(255,255,255,.2)';
  ctx.beginPath();ctx.moveTo(left,top);ctx.lineTo(left,H-bottom);ctx.lineTo(W-right,H-bottom);ctx.stroke();

  ctx.strokeStyle='#22c55e';ctx.beginPath();
  days.forEach((d,i)=>{
    const x=left+(i/(days.length-1))*iw;
    const y=top+ih-(d.v/max)*ih;
    if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

/* ===== Init ===== */
async function init(){
  await syncFromFirebase();
  render();drawChart();
}
init();
</script>
</body>
</html>
