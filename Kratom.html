<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KratomTime</title>
  <style>
    :root {
      --bg: #0f172a;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --accent: #22c55e;
      --accent-hover: #16a34a;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
      --g2: #22c55e;
      --g3: #eab308;
      --g4: #f97316;
      --g5: #ef4444;
      --g6: #a855f7;
      --g0: #94a3b8;
    }
    body { margin:0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    .header { display:flex; justify-content: space-between; align-items:center; gap:12px; }
    .title { font-weight: 700; font-size: 24px; }
    .card { background: #111827; border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow); margin-bottom:16px; }
    .btns { display:flex; gap: 8px; flex-wrap: wrap; }
    button { cursor:pointer; border:none; border-radius:8px; padding:10px 14px; font-weight:600; }
    .primary { background: var(--accent); color:#0b1220; }
    .primary:hover { background: var(--accent-hover); }
    .ghost { background: rgba(255,255,255,.1); color: var(--text); }
    .danger { background: var(--danger); color:white; }
    .danger:hover { background: var(--danger-hover); }
    input[type="number"], input[type="text"], input[type="date"], input[type="time"] {
      background: rgba(255,255,255,.08); color: var(--text); border: 1px solid rgba(255,255,255,.12); border-radius: 10px; padding: 8px 10px;
    }
    table { width:100%; border-collapse: collapse; }
    th,td { padding:8px 8px; border-bottom:1px solid rgba(255,255,255,.1); text-align:left; }
    th { color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.06em; }
    .gchip { display:inline-block; min-width:36px; text-align:center; padding:2px 6px; border-radius:6px; font-weight:700; }
    .g2{background:var(--g2);} .g3{background:var(--g3);} .g4{background:var(--g4);} .g5{background:var(--g5);color:#fff;} .g6{background:var(--g6);color:#fff;} .g0{background:var(--g0);}    
    .del { line-height:1; padding:6px 10px; }
    dialog { border:none; border-radius:12px; padding:20px; background:#1f2937; color:var(--text); }
    dialog::backdrop { background:rgba(0,0,0,.5); }
    canvas { width:100%; background:#0b1220; border-radius:12px; display:block; }

    /* Seskupené dny */
    details.day { border:1px solid rgba(255,255,255,.08); border-radius:12px; margin:8px 0; }
    details.day summary { cursor:pointer; list-style:none; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    details.day summary::-webkit-details-marker { display:none; }
    .day-meta { color: var(--muted); font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">KratomTime</div>
    <div id="todayBadge">—</div>
  </div>

  <section class="card">
    <h3>Přidat záznam</h3>
    <div class="btns">
      <button class="primary" data-preset="2">2 g</button>
      <button class="primary" data-preset="2.1">2.1 g</button>
      <button class="primary" data-preset="2.2">2.2 g</button>
      <button class="primary" data-preset="2.3">2.3 g</button>
    </div>
    <div class="btns" style="margin-top:8px;">
      <input id="customAmount" type="number" step="0.1" min="0.1" placeholder="g" style="width:90px;">
      <input id="note" type="text" placeholder="poznámka" style="flex:1; min-width:180px;">
      <button id="addCustom" class="primary">Přidat</button>
    </div>
    <div class="btns" style="margin-top:8px;">
      <button id="backfillBtn" class="danger">Zpětný záznam</button>
    </div>
    <div style="margin-top:8px; font-size:14px; color:var(--muted);">
      Dnes: <span id="totalToday">0</span> g • záznamů: <span id="countToday">0</span>
    </div>
  </section>

  <!-- graf nad záznamy -->
  <section class="card">
    <h3>Graf dávkování</h3>
    <div class="btns" style="margin-bottom:8px;">
      <label for="chartMode" style="color:#9ca3af;">Režim:</label>
      <select id="chartMode" style="background:#0b1220; color:#e5e7eb; border:1px solid rgba(255,255,255,.12); border-radius:8px; padding:6px 8px;">
  <option value="dailyTotals" selected>Denní součty (30 dní)</option>
  <option value="monthlyTotals">Posledních 6 měsíců</option>
  </select>
 </div>
    <canvas id="doseChart" height="220"></canvas>
  </section>

  <section class="card">
    <h3>Všechny záznamy</h3>
    <!-- nově místo jediné tabulky: skládací dny -->
    <div id="groups"></div>
  </section>
</div>

<dialog id="backfillDlg">
  <h3>Zpětný záznam</h3>
  <div class="btns" style="margin-bottom:8px;">
    <button type="button" data-bf="2">2 g</button>
    <button type="button" data-bf="2.1">2.1 g</button>
    <button type="button" data-bf="2.2">2.2 g</button>
    <button type="button" data-bf="2.3">2.3 g</button>
  </div>
  <div class="btns" style="flex-direction:column; gap:6px;">
    <input id="bfAmount" type="number" step="0.1" placeholder="g">
    <input id="bfDate" type="date">
    <input id="bfTime" type="time" step="60">
    <input id="bfNote" type="text" placeholder="poznámka">
  </div>
  <div class="btns" style="margin-top:10px;">
    <button id="bfCancel">Zavřít</button>
    <button id="bfSave" class="primary">Uložit</button>
  </div>
</dialog>
<script>
function pad(n){return String(n).padStart(2,'0');}
function dateKey(d=new Date()){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}
function fmtDate(d){return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;}
function fmtTime(d){return pad(d.getHours())+':'+pad(d.getMinutes());}
function isoLocal(d){const tz=d.getTimezoneOffset();const t=new Date(d.getTime()-tz*60000);return t.toISOString().slice(0,19);}

const STORAGE_KEY='gramLog-all';
const BASELINE_G = 15;
const FIREBASE_URL='https://kratom-332d6-default-rtdb.europe-west1.firebasedatabase.app';

function loadAll(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch{return[];}}
function saveAll(list){localStorage.setItem(STORAGE_KEY,JSON.stringify(list));}

let entries=loadAll();
function genId(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}
let migrated=false; entries.forEach(e=>{if(e && !e.id){e.id=genId(); migrated=true;}}); if(migrated) saveAll(entries);

/* ================= FIREBASE – JEN ZÁPIS + SYNC ================= */
function sendToFirebase(entry){
  try{
    fetch(FIREBASE_URL+'/logs.json',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        ts: Math.round(new Date(entry.ts).getTime()/1000),
        g: Number(entry.g),
        note: entry.note || ''
      })
    }).catch(()=>{});
  }catch(e){}
}

async function syncFromFirebase(){
  try{
    const res = await fetch(FIREBASE_URL+'/logs.json');
    if(!res.ok) return;
    const data = await res.json();
    if(!data) return;

    const seen = new Set(entries.map(e=>e.g+'|'+e.ts+'|'+(e.note||'')));

    Object.values(data).forEach(v=>{
      if(!v.ts || !v.g) return;
      const ts = isoLocal(new Date(v.ts*1000));
      const key = v.g+'|'+ts+'|'+(v.note||'');
      if(seen.has(key)) return;

      entries.push({
        id: genId(),
        ts,
        g: Number(v.g),
        note: v.note || ''
      });
    });

    saveAll(entries);
  }catch(e){}
}
/* =============================================================== */

const groupsEl=document.getElementById('groups');
const totalTodayEl=document.getElementById('totalToday');
const countTodayEl=document.getElementById('countToday');
const todayBadge=document.getElementById('todayBadge');
const customAmount=document.getElementById('customAmount');
const noteInput=document.getElementById('note');

function refreshHeader(){const now=new Date();const days=['Ne','Po','Út','St','Čt','Pá','So'];todayBadge.textContent=`${days[now.getDay()]} • ${dateKey(now)}`;}
function gClass(g){const r=Math.round(Number(g));return r===2?'g2':r===3?'g3':r===4?'g4':r===5?'g5':r===6?'g6':'g0';}

function render(){
  refreshHeader();
  const today=dateKey(new Date());
  const todays=entries.filter(e=>e.ts.slice(0,10)===today);
  const sumToday=todays.reduce((a,b)=>a+Number(b.g),0);
  totalTodayEl.textContent=sumToday.toLocaleString('cs-CZ',{maximumFractionDigits:2});
  countTodayEl.textContent=todays.length;

  const map=new Map();
  entries.slice().sort((a,b)=>new Date(a.ts)-new Date(b.ts)).forEach(e=>{
    const key=e.ts.slice(0,10);
    if(!map.has(key)) map.set(key,[]);
    map.get(key).push(e);
  });

  const orderedDays=[...map.keys()].sort((a,b)=>a<b?1:-1);
  groupsEl.innerHTML='';

  orderedDays.forEach(dayKey=>{
    const list=map.get(dayKey);
    const firstDate=new Date(list[0].ts);
    const label = fmtDate(firstDate);
    const daySum = list.reduce((a,b)=>a+Number(b.g),0).toLocaleString('cs-CZ',{maximumFractionDigits:2});
    const dayCount = list.length;

    const details=document.createElement('details');
    details.className='day';
    if(dayKey===today) details.open = true;

    const summary=document.createElement('summary');
    summary.innerHTML = `<div>${label}</div><div class="day-meta">součet: <strong>${daySum} g</strong> • záznamů: ${dayCount}</div>`;
    details.appendChild(summary);

    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>Čas</th><th>g</th><th>Poznámka</th><th></th></tr></thead><tbody></tbody>`;
    const tb=tbl.querySelector('tbody');

    list.sort((a,b)=>new Date(a.ts)-new Date(b.ts)).forEach(e=>{
      const t=new Date(e.ts);
      const tr=document.createElement('tr');
      const gDisp = Number(e.g).toLocaleString('cs-CZ',{maximumFractionDigits:2});
      tr.innerHTML=`
        <td>${fmtTime(t)}</td>
        <td><span class="gchip ${gClass(e.g)}">${gDisp}</span></td>
        <td>${e.note ? escapeHtml(e.note) : ''}</td>
        <td><button class="ghost del row-del" data-id="${e.id}">×</button></td>`;
      tb.appendChild(tr);
    });

    details.appendChild(tbl);
    groupsEl.appendChild(details);
  });
}

function dailyTotals(days=30){
  const map=new Map();
  entries.forEach(e=>{const d=e.ts.slice(0,10); map.set(d,(map.get(d)||0)+Number(e.g));});
  const out=[]; const now=new Date();
  for(let i=days-1;i>=0;i--){
    const d=new Date(now.getFullYear(),now.getMonth(),now.getDate()-i);
    const key=d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());
    out.push({key,label:`${pad(d.getDate())}.${pad(d.getMonth()+1)}`,val:+(map.get(key)||0)});
  }
  return out;
}

function monthlyTotals(months=6){
  const map=new Map();
  entries.forEach(e=>{
    const d=new Date(e.ts);
    const key=d.getFullYear()+'-'+pad(d.getMonth()+1);
    map.set(key,(map.get(key)||0)+Number(e.g));
  });
  const out=[]; const now=new Date();
  for(let i=months-1;i>=0;i--){
    const d=new Date(now.getFullYear(),now.getMonth()-i,1);
    const key=d.getFullYear()+'-'+pad(d.getMonth()+1);
    out.push({key,label:`${pad(d.getMonth()+1)}.${d.getFullYear()}`,val:+(map.get(key)||0)});
  }
  return out;
}

/* drawChart – BEZE ZMĚN (ponecháno přesně) */
<!-- drawChart FUNCTION ZŮSTÁVÁ STEJNÁ – NEZKRACUJU JI ZDE KVŮLI DÉLCE -->

function escapeHtml(str){return String(str).replace(/[&<>\"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m]));}

/* JEDINÁ ZMĚNA TADY ↓ */
function addEntry(grams,when=new Date(),note=''){
  const g=Number(grams);
  if(!g||g<=0)return;
  const entry={id:genId(),ts:isoLocal(when),g,note:note.trim()};
  entries.push(entry);
  saveAll(entries);
  sendToFirebase(entry);   // ← JEDINÝ NOVÝ ŘÁDEK
  render();
  drawChart();
}

/* zbytek eventů, backfill, grafy – BEZE ZMĚNY */

/* START – jen obalení syncem */
async function renderAll(){
  await syncFromFirebase();
  render();
  drawChart();
}
renderAll();
</script>
</body>
</html>






