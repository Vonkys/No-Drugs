<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmokeTrack ‚Äì Cigarety & Jointy</title>
  <style>
    :root {
      --bg: #0f172a; --panel:#111827; --muted:#9ca3af; --text:#e5e7eb; --shadow:0 10px 25px rgba(0,0,0,.35);
      --cig:#60a5fa;  /* modr√° */
      --joint:#22c55e;/* zelen√° */
      --accent:#22c55e; --accent2:#60a5fa; --danger:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .title{font-weight:800;font-size:24px}
    .card{background:var(--panel);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);margin-bottom:16px}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700}
    .primary{background:var(--accent);color:#0b1220}
    .alt{background:var(--accent2);color:#0b1220}
    .ghost{background:rgba(255,255,255,.1);color:var(--text)}
    .danger{background:var(--danger);color:#fff}
    input,select{background:rgba(255,255,255,.08);color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px 10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.1);text-align:left}
    th{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.06em}
    dialog{border:none;border-radius:12px;padding:20px;background:#1f2937;color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    details.day{border:1px solid rgba(255,255,255,.08);border-radius:12px;margin:8px 0}
    details.day summary{cursor:pointer;list-style:none;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    details.day summary::-webkit-details-marker{display:none}
    .badge{display:inline-flex;gap:6px;align-items:center}
    .dot{width:10px;height:10px;border-radius:6px;background:#fff;display:inline-block}
    .dot.cig{background:var(--cig)} .dot.joint{background:var(--joint)}
    canvas{width:100%;background:#0b1220;border-radius:12px;display:block}
   .btns .break {
  flex-basis: 100%;
  width: fit-content;}
 /* VAROV√ÅN√ç */
    .warn {
    color: #ef4444 !important;
    font-weight: 800;
    animation: blink 1.2s infinite;
   }
  @keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.35; }
  }
  .progress-btn {
  position: relative;
  overflow: hidden;
}

.progress-btn::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: 0;
  height: 4px;
  width: var(--p, 0%);
  background: #22c55e;
  transition: width 0.4s linear;
}

  /* i teƒçka */
  .dot.warn {
  background: #ef4444 !important;
  }
     /* --- ZHU≈†TƒöN√â ≈ò√ÅDKY SOUƒåT≈Æ --- */
    .totals{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:8px;color:var(--muted)}
    .totals .sep{margin:0 4px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08)}
    @media (max-width:420px){
      .totals{gap:6px}
      .pill{padding:3px 7px;font-size:14px}
      .totals .sep{margin:0 2px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">NoSmoke üö≠</div>
    <div id="todayBadge">‚Äî</div>
  </div>

  <!-- Rychl√Ω z√°znam -->
  <section class="card">
    <h3>üìñ‚úèÔ∏è P≈ôidej vykou≈ôen√©</h3>
   <div class="btns">
  <button id="btnCig" class="alt">+ Cigareta</button>
  <button id="btnJoint" class="primary">+ Joint</button>
</div>

<div class="btns" style="margin-top:20px">
  <button id="backfillBtn" class="danger">Zpƒõtn√Ω z√°znam</button>
</div>


    <!-- Denn√≠ souƒçty ‚Äì ZHU≈†TƒöNO -->
    <div class="totals">
      <span>Dnes:</span>
      <span class="pill"><span class="dot cig"></span><strong id="todayCig">0</strong> cig</span>
      <span class="pill"><span class="dot joint"></span><strong id="todayJoint">0</strong> joint</span>
      </div>

    <!-- Mƒõs√≠ƒçn√≠ souƒçty -->
    <div class="totals">
      <span>Mƒõs√≠c:</span>
      <span class="pill"><span class="dot cig"></span><strong id="monthCig">0</strong> cig</span>
      <span class="pill"><span class="dot joint"></span><strong id="monthJoint">0</strong> joint</span>
     </div>
    <!-- Denn√≠ pr≈Ømƒõr -->
    <div class="totals">
    <span>Pr≈Ømƒõr:</span>
    <span class="pill">
    <span class="dot cig"></span>
    <strong id="avgCig">0</strong> cig
    </span>
    <span class="pill">
    <span class="dot joint"></span>
    <strong id="avgJoint">0</strong> joint
    </span>
    </div>
    </section>

  <!-- Graf -->
  <section class="card">
    <h3>GRAF D√ÅVKOV√ÅN√ç üìà</h3>
    <div class="btns" style="margin-bottom:8px;align-items:center">
      <label for="chartMode" style="color:#9ca3af">Re≈æim:</label>
      <select id="chartMode">
        <option value="dailyTotals" selected>Den üåû</option>
        <option value="monthlyCaps">Mƒõs√≠c üåõ</option>
      </select>
    </div>
    <canvas id="chart" height="220"></canvas>
    <div style="margin-top:8px;color:var(--muted)">
      <span class="badge"><span class="dot cig"></span>Cigarety</span>
      <span class="badge" style="margin-left:10px"><span class="dot joint"></span>Jointy</span>
    </div>
  </section>

  <!-- V≈°echny z√°znamy -->
  <section class="card">
    <h3>V≈°echny z√°znamy</h3>
    <div id="groups"></div>
  </section>
</div>

<!-- Dialog zpƒõtn√©ho z√°znamu -->
<dialog id="backfillDlg">
  <h3>Zpƒõtn√Ω z√°znam</h3>
  <div class="btns" style="flex-direction:column;gap:6px">
    <select id="bfType">
      <option value="cig">Cigareta</option>
      <option value="joint">Joint</option>
    </select>
    <input id="bfDate" type="date">
    <input id="bfTime" type="time" step="60">
    <input id="bfNote" type="text" placeholder="pozn√°mka (voliteln√©)">
  </div>
  <div class="btns" style="margin-top:10px">
    <button id="bfCancel">Zav≈ô√≠t</button>
    <button id="bfSave" class="primary">Ulo≈æit</button>
  </div>
</dialog>

<script>
/* ===== Pomocn√© ===== */
function pad(n){return String(n).padStart(2,'0')}
function dateKey(d=new Date()){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())}
function fmtDate(d){return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`}
function fmtTime(d){return pad(d.getHours())+':'+pad(d.getMinutes())}
function isoLocal(d){
  const tz=d.getTimezoneOffset();
  const t=new Date(d.getTime()-tz*60000);
  return t.toISOString().slice(0,19);
}
function escapeHtml(s){return String(s||'').replace(/[&<>\"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m]))}

/* ===== Nastaven√≠ LocalStorage + Firebase ===== */
const STORAGE_KEY='smoketrack-entries-v1';
const FIREBASE_URL='https://cigaro-default-rtdb.europe-west1.firebasedatabase.app';
const WARN_LIMITS = { cig: 12, joint: 3 };
const LOCK_KEY = 'nosmoke-cig-lock';
const LOCK_MINUTES = 15;
function loadAll(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }
  catch{ return []; }
}
function saveAll(list){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}
function genId(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}

let entries = loadAll(); // {id, ts, type:'cig'|'joint', note}

/* ===== Firebase sync ===== */

// po≈°li nov√Ω z√°znam i do Firebase (z webu)
function sendToFirebase(entry){
  try{
    const tsMs = new Date(entry.ts).getTime();
    if(!Number.isFinite(tsMs)) return;
    const payload = {
      ts: Math.round(tsMs/1000),
      type: entry.type,
      source: 'web',
      note: entry.note || ''
    };
    fetch(FIREBASE_URL + '/logs.json', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    }).catch(()=>{});
  } catch(e){
    console.error('Firebase send error', e);
  }
}

// naƒçti z√°znamy z Firebase (vƒç. tƒõch z hodinek) a slouƒç s entries
async function syncFromFirebase(){
  try{
    const res = await fetch(FIREBASE_URL + '/logs.json');
    if(!res.ok) return;
    const data = await res.json();
    if(!data) return;

    // posledn√≠ cig√°ro v lok√°ln√≠ch datech
    const lastLocalCig = entries
      .filter(e => e.type === 'cig')
      .sort((a,b)=> new Date(b.ts) - new Date(a.ts))[0];

    let lastCigTs = lastLocalCig
      ? new Date(lastLocalCig.ts).getTime()
      : 0;

    const LOCK_MS = LOCK_MINUTES * 60 * 1000;
    const fbEntries = [];

    // se≈ôaƒè Firebase z√°znamy chronologicky
    const ordered = Object.entries(data)
      .map(([key,val]) => ({ key, val }))
      .filter(o => o.val && o.val.ts && o.val.type)
      .sort((a,b)=>{
        const ta = Number(a.val.ts);
        const tb = Number(b.val.ts);
        return ta - tb;
      });

    for(const {key, val} of ordered){
      let tsNum = typeof val.ts === 'number'
        ? val.ts
        : parseInt(val.ts, 10);

      if(!tsNum) continue;

      const tsMs = tsNum * 1000;

      // üö´ tvrd√Ω filtr duplicitn√≠ cigarety
      if(val.type === 'cig'){
        if(lastCigTs && (tsMs - lastCigTs) < LOCK_MS){
          continue; // ignoruj spam z hodinek
        }
        lastCigTs = tsMs; // posu≈à lock
      }

      fbEntries.push({
        id: 'fb-' + key,
        ts: isoLocal(new Date(tsMs)),
        type: val.type === 'joint' ? 'joint' : 'cig',
        note: val.note ? String(val.note) : ''
      });
    }

    // slouƒçen√≠ + deduplikace
    const all = [...entries, ...fbEntries];
    const seen = new Set();

    entries = all.filter(e=>{
      const k = e.type + '|' + e.ts + '|' + (e.note || '');
      if(seen.has(k)) return false;
      seen.add(k);
      return true;
    });

    saveAll(entries);

  } catch(e){
    console.error('Firebase sync failed', e);
  }
}


/* ===== UI refs ===== */
const groupsEl=document.getElementById('groups');
const todayBadge=document.getElementById('todayBadge');
const todayCig=document.getElementById('todayCig');
const todayJoint=document.getElementById('todayJoint');


const btnCig=document.getElementById('btnCig');
const btnJoint=document.getElementById('btnJoint');

const backfillBtn=document.getElementById('backfillBtn');
const backfillDlg=document.getElementById('backfillDlg');
const bfType=document.getElementById('bfType');
const bfDate=document.getElementById('bfDate');
const bfTime=document.getElementById('bfTime');
const bfNote=document.getElementById('bfNote');

const chartMode=document.getElementById('chartMode');

function refreshHeader(){
  const now=new Date();
  const days=['Ne','Po','√öt','St','ƒåt','P√°','So'];
  todayBadge.textContent=`${days[now.getDay()]} ‚Ä¢ ${dateKey(now)}`;
}

function addEntry(type, when=new Date(), note=''){
  // ‚õî blokace cigarety
  if(type === 'cig'){
    const lockUntil = Number(localStorage.getItem(LOCK_KEY) || 0);
    if(Date.now() < lockUntil){
      alert('Cigareta u≈æ byla ned√°vno zaznamenan√° üòâ');
      return;
    }
  }

  const entry = {
    id: genId(),
    ts: isoLocal(when),
    type,
    note: note.trim()
  };

  entries.push(entry);
  saveAll(entries);
  sendToFirebase(entry);

  // üîí nastav lock na 15 minut
  if(type === 'cig'){
    localStorage.setItem(
      LOCK_KEY,
      Date.now() + LOCK_MINUTES * 60 * 1000
    );
  }

  render();
  drawChart();
}


btnCig.addEventListener('click',()=>addEntry('cig'));
btnJoint.addEventListener('click',()=>addEntry('joint'));




backfillBtn.addEventListener('click',()=>{
  const now=new Date();
  bfDate.value=now.toISOString().slice(0,10);
  bfTime.value=`${pad(now.getHours())}:${pad(now.getMinutes())}`;
  bfType.value='cig'; bfNote.value='';
  backfillDlg.showModal();
});

document.getElementById('bfCancel').addEventListener('click',()=>backfillDlg.close());
document.getElementById('bfSave').addEventListener('click',()=>{
  const d=bfDate.value; const t=bfTime.value||'00:00';
  if(!d){alert('Zadej datum');return;}
  const [Y,M,D]=d.split('-').map(Number);
  const [H,Min]=t.split(':').map(Number);
  const when=new Date(Y,(M||1)-1,(D||1),H||0,Min||0);
  addEntry(bfType.value, when, bfNote.value);
  backfillDlg.close();
});
function updateCigLock(){
  const btn = btnCig;
  const lockUntil = Number(localStorage.getItem(LOCK_KEY) || 0);
  const now = Date.now();
  const diff = lockUntil - now;

  if(diff > 0){
    const total = LOCK_MINUTES * 60 * 1000;
    const done = total - diff;
    const percent = Math.min(100, Math.max(0, (done / total) * 100));

    btn.disabled = true;
    btn.classList.add('ghost', 'progress-btn');
    btn.style.setProperty('--p', percent + '%');

    const min = Math.ceil(diff / 60000);
    btn.textContent = `‚è≥ ${min} min`;
  } else {
    btn.disabled = false;
    btn.classList.remove('ghost', 'progress-btn');
    btn.style.removeProperty('--p');
    btn.textContent = '+ Cigareta';
    localStorage.removeItem(LOCK_KEY);
  }
}

function deleteEntry(id){
  if(!confirm('Smazat z√°znam?')) return;

  entries = entries.filter(e => e.id !== id);
  saveAll(entries);
  render();
  drawChart();
}
function syncCigLockFromEntries(){
  const lastCig = entries
    .filter(e => e.type === 'cig')
    .sort((a,b)=> new Date(b.ts) - new Date(a.ts))[0];

  if(!lastCig) return;

  const lastTs = new Date(lastCig.ts).getTime();
  const lockUntil = lastTs + LOCK_MINUTES * 60 * 1000;

  if(lockUntil > Date.now()){
    localStorage.setItem(LOCK_KEY, lockUntil);
  }
}

/* ===== Render tabulek + souƒçty ===== */
function render(){
  refreshHeader();
  updateCigLock();
  /* ===== DNES ===== */
  const today = dateKey(new Date());
  const todays = entries.filter(e => e.ts.slice(0,10) === today);

  const cCig = todays.filter(e => e.type === 'cig').length;
  const cJoint = todays.filter(e => e.type === 'joint').length;

  todayCig.textContent = cCig;
  todayJoint.textContent = cJoint;

  /* ===== MƒöS√çC ===== */
  const now = new Date();
  const monthPrefix = now.toISOString().slice(0,7);
  const monthEntries = entries.filter(e => e.ts.slice(0,7) === monthPrefix);

  const mCig = monthEntries.filter(e => e.type === 'cig').length;
  const mJoint = monthEntries.filter(e => e.type === 'joint').length;

  document.getElementById('monthCig').textContent = mCig;
  document.getElementById('monthJoint').textContent = mJoint;

  /* ===== DENN√ç PR≈ÆMƒöR (jen aktivn√≠ dny) ===== */
  const activeDays = new Set(
    monthEntries.map(e => e.ts.slice(0,10))
  );

  const daysCount = activeDays.size || 1;

  const avgCig = mCig / daysCount;
  const avgJoint = mJoint / daysCount;

  document.getElementById('avgCig').textContent =
    avgCig.toLocaleString('cs-CZ',{ maximumFractionDigits:1 });

  document.getElementById('avgJoint').textContent =
    avgJoint.toLocaleString('cs-CZ',{ maximumFractionDigits:1 });

  /* ===== SESKUPEN√ç: MƒöS√çC ‚Üí DEN ===== */
  const byMonth = new Map();

  entries
    .slice()
    .sort((a,b)=>new Date(a.ts)-new Date(b.ts))
    .forEach(e=>{
      const monthKey = e.ts.slice(0,7);   // YYYY-MM
      const dayKey   = e.ts.slice(0,10);  // YYYY-MM-DD

      if(!byMonth.has(monthKey)) byMonth.set(monthKey, new Map());
      const days = byMonth.get(monthKey);

      if(!days.has(dayKey)) days.set(dayKey, []);
      days.get(dayKey).push(e);
    });

  groupsEl.innerHTML = '';

  const currentMonth = new Date().toISOString().slice(0,7);
  const orderedMonths = [...byMonth.keys()].sort((a,b)=>a<b?1:-1);

  orderedMonths.forEach(monthKey=>{
    const monthDetails = document.createElement('details');
    if(monthKey === currentMonth) monthDetails.open = true;

    const daysMap = byMonth.get(monthKey);

    let mc = 0, mj = 0;
    daysMap.forEach(list=>{
      mc += list.filter(e=>e.type==='cig').length;
      mj += list.filter(e=>e.type==='joint').length;
    });

    const [Y,M] = monthKey.split('-');
    const monthSummary = document.createElement('summary');
    monthSummary.innerHTML = `
      <strong>${M}/${Y}</strong>
      <span class="pill"><span class="dot cig"></span>${mc} cig</span>
      <span class="pill"><span class="dot joint"></span>${mj} joint</span>
    `;
    monthDetails.appendChild(monthSummary);

    const orderedDays = [...daysMap.keys()].sort((a,b)=>a<b?1:-1);

    orderedDays.forEach(dayKey=>{
      const list = daysMap.get(dayKey);
      const dt = new Date(list[0].ts);

      const cig = list.filter(e=>e.type==='cig').length;
      const joi = list.filter(e=>e.type==='joint').length;

      const cigWarn = cig > WARN_LIMITS.cig;
      const joiWarn = joi > WARN_LIMITS.joint;

      const dayDetails = document.createElement('details');
      dayDetails.className = 'day';
      if(dayKey === today) dayDetails.open = true;

      dayDetails.innerHTML = `
        <summary>
          <div>${fmtDate(dt)}</div>
          <div class="badge ${cigWarn ? 'warn' : ''}">
            <span class="dot cig ${cigWarn ? 'warn' : ''}"></span>
            ${cig} cig
          </div>
          <div class="badge ${joiWarn ? 'warn' : ''}">
            <span class="dot joint ${joiWarn ? 'warn' : ''}"></span>
            ${joi} joint
          </div>
        </summary>
      `;

      const tbl = document.createElement('table');
      tbl.innerHTML = `
        <thead>
          <tr><th>ƒåas</th><th>Typ</th><th>Pozn√°mka</th><th></th></tr>
        </thead>
        <tbody></tbody>
      `;
      const tb = tbl.querySelector('tbody');

      list
        .slice()
        .sort((a,b)=>new Date(a.ts)-new Date(b.ts))
        .forEach(e=>{
          const t = new Date(e.ts);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtTime(t)}</td>
            <td>${e.type==='cig'?'Cigareta':'Joint'}</td>
            <td>${escapeHtml(e.note)}</td>
            <td><button class="ghost row-del" data-id="${e.id}">√ó</button></td>
          `;
          tb.appendChild(tr);
        });

      dayDetails.appendChild(tbl);
      monthDetails.appendChild(dayDetails);
    });

    groupsEl.appendChild(monthDetails);
  });
}


/* ===== Grafy ===== */
const chart=document.getElementById('chart'); const ctx=chart.getContext('2d');

/* --- nastaven√≠ ‚Äûcap≈Ø‚Äú (max/den) pro mƒõs√≠ƒçn√≠ re≈æim --- */
const MAX_PER_DAY = { cig: 12, joint: 3 };

function getRangeDays(n=30){
  const out=[]; const now=new Date();
  for(let i=n-1;i>=0;i--){ const d=new Date(now.getFullYear(),now.getMonth(),now.getDate()-i); out.push(d); }
  return out;
}

function dailyTotals(n=30){
  const days=getRangeDays(n); const mapC=new Map(), mapJ=new Map();
  entries.forEach(e=>{
    const key=e.ts.slice(0,10);
    if(e.type==='cig') mapC.set(key,(mapC.get(key)||0)+1);
    else mapJ.set(key,(mapJ.get(key)||0)+1);
  });
  return days.map(d=>{
    const k=dateKey(d);
    return {
      label:`${pad(d.getDate())}.${pad(d.getMonth()+1)}`,
      cig:(mapC.get(k)||0),
      joint:(mapJ.get(k)||0)
    };
  });
}

/* --- pomocn√© pro mƒõs√≠ƒçn√≠ agregaci --- */
function daysInMonth(y, m){ return new Date(y, m+1, 0).getDate(); } // m=0..11
function lastNMonths(n=6){
  const out=[]; const now=new Date();
  for(let i=n-1;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth()-i, 1); out.push({y:d.getFullYear(), m:d.getMonth()}); }
  return out;
}
function monthlyCapsData(n=6){
  const months=lastNMonths(n);
  const map=new Map();
  entries.forEach(e=>{
    const k=e.ts.slice(0,7);
    if(!map.has(k)) map.set(k,[]);
    map.get(k).push(e);
  });
  return months.map(({y,m})=>{
    const key=`${y}-${pad(m+1)}`;
    const list=map.get(key)||[];
    const dpm=daysInMonth(y,m);
    const cigTot=list.filter(e=>e.type==='cig').length;
    const joiTot=list.filter(e=>e.type==='joint').length;
    const cigCap=dpm*MAX_PER_DAY.cig, joiCap=dpm*MAX_PER_DAY.joint;
    return {
      label:`${pad(m+1)}/${String(y).slice(-2)}`,
      cig:{ total:cigTot, cap:cigCap, ratio:cigCap?cigTot/cigCap:0 },
      joint:{ total:joiTot, cap:joiCap, ratio:joiCap?joiTot/joiCap:0 }
    };
  });
}

function drawChart() {
  const W = chart.width = chart.clientWidth;
  const H = chart.height;
  ctx.clearRect(0, 0, W, H);

  const left = 40, right = 10, top = 12, bottom = 28;
  const innerW = W - left - right;
  const innerH = H - top - bottom;

  const mode = chartMode.value;

  const cigColor =
    getComputedStyle(document.documentElement).getPropertyValue('--cig').trim() || '#60a5fa';
  const jointColor =
    getComputedStyle(document.documentElement).getPropertyValue('--joint').trim() || '#22c55e';

  /* ===== Osy ===== */
  ctx.strokeStyle = 'rgba(255,255,255,.25)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(left, top);
  ctx.lineTo(left, H - bottom);
  ctx.lineTo(W - right, H - bottom);
  ctx.stroke();

  ctx.font = '12px system-ui';

  /* =====================================================
     DENN√ç SOUƒåTY ‚Äì LINE CHART
  ===================================================== */
  if (mode === 'dailyTotals') {
    const data = dailyTotals(30);
    const maxVal = Math.max(1, ...data.map(d => Math.max(d.cig || 0, d.joint || 0)));
    const yMax = maxVal + 1;

    const steps = 4;
    for (let i = 0; i <= steps; i++) {
      const y = top + innerH - (i / steps) * innerH;
      const v = (i / steps) * yMax;
      ctx.strokeStyle = 'rgba(255,255,255,.12)';
      ctx.beginPath();
      ctx.moveTo(left, y);
      ctx.lineTo(W - right, y);
      ctx.stroke();
      ctx.fillStyle = 'rgba(255,255,255,.75)';
      ctx.textAlign = 'left';
      ctx.fillText(v.toFixed(0), 6, y + 4);
    }

    const xFor = i =>
      left + (data.length === 1 ? 0 : (i / (data.length - 1)) * innerW);
    const yFor = v =>
      top + innerH - (v / yMax) * innerH;

    function drawLine(key, color) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      let pen = false;

      data.forEach((d, i) => {
        const v = d[key] || 0;
        if (v <= 0) {
          pen = false;
          return;
        }
        const x = xFor(i);
        const y = yFor(v);
        if (!pen) {
          ctx.moveTo(x, y);
          pen = true;
        } else {
          ctx.lineTo(x, y);
        }
      });

      ctx.stroke();

      ctx.fillStyle = color;
      data.forEach((d, i) => {
        const v = d[key] || 0;
        if (v <= 0) return;
        const x = xFor(i);
        const y = yFor(v);
        ctx.beginPath();
        ctx.arc(x, y, 2.5, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    drawLine('cig', cigColor);
    drawLine('joint', jointColor);

    ctx.fillStyle = 'rgba(255,255,255,.75)';
    ctx.textAlign = 'center';
    const step = Math.max(1, Math.ceil(data.length / 6));
    data.forEach((d, i) => {
      if (i % step === 0 || i === data.length - 1) {
        ctx.fillText(d.label, xFor(i), H - 8);
      }
    });

    return;
  }

  /* =====================================================
     MƒöS√çƒåN√ç P≈òEHLED ‚Äì BAR CHART
  ===================================================== */
  if (mode === 'monthlyCaps') {
    const data = monthlyCapsData(6);

    const steps = 4;
    for (let i = 0; i <= steps; i++) {
      const y = top + innerH - (i / steps) * innerH;
      const v = (i / steps) * 100;
      ctx.strokeStyle = 'rgba(255,255,255,.12)';
      ctx.beginPath();
      ctx.moveTo(left, y);
      ctx.lineTo(W - right, y);
      ctx.stroke();
      ctx.fillStyle = 'rgba(255,255,255,.75)';
      ctx.textAlign = 'left';
      ctx.fillText(v.toFixed(0) + '%', 6, y + 4);
    }

    const colW = innerW / data.length;
    const barW = Math.min(26, (colW - 16) / 2);
    const xForCol = i => left + i * colW + colW / 2;

 function drawBar(xc, ratio, color) {
  // skuteƒçn√Ω pomƒõr (m≈Ø≈æe b√Ωt > 1)
  const r = Math.max(0, ratio);

  // vizu√°ln√≠ limit sloupce (max 100 % v√Ω≈°ky)
  const capped = Math.min(1, r);

  // v√Ω≈°ka sloupce
  const h = innerH * capped;
  const yTop = top + innerH - h;

  // üî¥ pokud je nad 100 %, p≈ôebarvi na ƒçervenou
  const barColor = r > 1 ? '#ef4444' : color;

  ctx.fillStyle = barColor;
  ctx.fillRect(xc - barW / 2, yTop, barW, h);

  return { h, yTop };
}

  function drawValue(xc, bar, value) {
  if (!bar || bar.h <= 0) return;

  const text = String(value);

  ctx.save();
  ctx.fillStyle = '#ffffff';

  if (bar.h > 32) {
    ctx.font = '18px system-ui';

    // 1Ô∏è‚É£ jdi p≈ôesnƒõ do st≈ôedu sloupce
    ctx.translate(xc, bar.yTop + bar.h / 2);

    // 2Ô∏è‚É£ otoƒç
    ctx.rotate(-Math.PI / 2);

    // 3Ô∏è‚É£ centrov√°n√≠ textu
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // 4Ô∏è‚É£ kresli do (0,0)
    ctx.fillText(text, 0, 0);

  } else {
    ctx.font = '14px system-ui';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    ctx.fillText(text, xc, bar.yTop - 4);
  }

  ctx.restore();
}



    data.forEach((m, i) => {
      const cx = xForCol(i);

      const cigX = cx - (barW / 2 + 4);
      const cigBar = drawBar(cigX, m.cig.ratio, cigColor);
      drawValue(cigX, cigBar, m.cig.total);

      const jointX = cx + (barW / 2 + 4);
      const jointBar = drawBar(jointX, m.joint.ratio, jointColor);
      drawValue(jointX, jointBar, m.joint.total);

      ctx.font = '12px system-ui';
      ctx.fillStyle = 'rgba(255,255,255,.85)';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'alphabetic';
      ctx.fillText(m.label, cx, H - 8);
    });

    return;
  }
}



/* ===== Init ===== */
let rAf;
window.addEventListener('resize',()=>{
  cancelAnimationFrame(rAf);
  rAf=requestAnimationFrame(drawChart);
});
chartMode.addEventListener('change', drawChart);

function renderAll(){ render(); drawChart(); }

async function init(){
  await syncFromFirebase();
  syncCigLockFromEntries(); // üëà KL√çƒåOV√â
  renderAll();
}

init();
setInterval(updateCigLock, 30_000); // ka≈æd√Ωch 30 sekund

/* ===== Quick ?quick=cig / joint ===== */
let quickDone = false;
function handleQuick() {
  if (quickDone) return;
  const params = new URLSearchParams(window.location.search);
  const quick = params.get('quick');
  if (!quick) return;

  const targetId =
    quick === 'cig' ? 'btnCig' :
    quick === 'joint' ? 'btnJoint' :
    null;
  if (!targetId) return;

  const btn = document.getElementById(targetId);
  if (btn) {
    btn.click();
    quickDone = true;
    console.log("Quick logged:", quick);
  }
}
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(handleQuick, 120);
});
groupsEl.addEventListener('click', e => {
  const btn = e.target.closest('.row-del');
  if(!btn) return;

  const id = btn.dataset.id;
  if(id) deleteEntry(id);
});
setInterval(async () => {
  await syncFromFirebase();
  syncCigLockFromEntries();
  render();
}, 60_000); // ka≈ædou minutu

</script>
</body>
</html>
