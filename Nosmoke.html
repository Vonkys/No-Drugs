<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmokeTrack – Cigarety & Jointy</title>
  <style>
    :root {
      --bg: #0f172a; --panel:#111827; --muted:#9ca3af; --text:#e5e7eb; --shadow:0 10px 25px rgba(0,0,0,.35);
      --cig:#60a5fa;  /* modrá */
      --joint:#22c55e;/* zelená */
      --accent:#22c55e; --accent2:#60a5fa; --danger:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .title{font-weight:800;font-size:24px}
    .card{background:var(--panel);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);margin-bottom:16px}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700}
    .primary{background:var(--accent);color:#0b1220}
    .alt{background:var(--accent2);color:#0b1220}
    .ghost{background:rgba(255,255,255,.1);color:var(--text)}
    .danger{background:var(--danger);color:#fff}
    input,select{background:rgba(255,255,255,.08);color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px 10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.1);text-align:left}
    th{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.06em}
    dialog{border:none;border-radius:12px;padding:20px;background:#1f2937;color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    details.day{border:1px solid rgba(255,255,255,.08);border-radius:12px;margin:8px 0}
    details.day summary{cursor:pointer;list-style:none;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    details.day summary::-webkit-details-marker{display:none}
    .badge{display:inline-flex;gap:6px;align-items:center}
    .dot{width:10px;height:10px;border-radius:6px;background:#fff;display:inline-block}
    .dot.cig{background:var(--cig)} .dot.joint{background:var(--joint)}
    canvas{width:100%;background:#0b1220;border-radius:12px;display:block}

    /* --- ZHUŠTĚNÉ ŘÁDKY SOUČTŮ --- */
    .totals{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:8px;color:var(--muted)}
    .totals .sep{margin:0 4px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08)}
    @media (max-width:420px){
      .totals{gap:6px}
      .pill{padding:3px 7px;font-size:14px}
      .totals .sep{margin:0 2px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">SmokeTrack</div>
    <div id="todayBadge">—</div>
  </div>

  <!-- Rychlý záznam -->
  <section class="card">
    <h3>Rychlý záznam</h3>
    <div class="btns">
      <button id="btnCig" class="alt">+ Cigareta</button>
      <button id="btnJoint" class="primary">+ Joint</button>
      <button id="backfillBtn" class="ghost">Zpětný záznam</button>
      <button id="undoBtn" class="ghost">Zpět poslední</button>
      <button id="resetBtn" class="danger">Vynulovat vše</button>
    </div>

    <!-- Denní součty – ZHUŠTĚNO -->
    <div class="totals">
      <span>Dnes:</span>
      <span class="pill"><span class="dot cig"></span><strong id="todayCig">0</strong> cig</span>
      <span class="pill"><span class="dot joint"></span><strong id="todayJoint">0</strong> joint</span>
      <span class="sep">•</span><span>celkem <strong id="todayAll">0</strong></span>
    </div>

    <!-- NOVÉ: Měsíční součty -->
    <div class="totals">
      <span>Měsíc:</span>
      <span class="pill"><span class="dot cig"></span><strong id="monthCig">0</strong> cig</span>
      <span class="pill"><span class="dot joint"></span><strong id="monthJoint">0</strong> joint</span>
      <span class="sep">•</span><span>celkem <strong id="monthAll">0</strong></span>
    </div>
  </section>

  <!-- Graf -->
  <section class="card">
    <h3>Graf</h3>
    <div class="btns" style="margin-bottom:8px;align-items:center">
      <label for="chartMode" style="color:#9ca3af">Režim:</label>
      <select id="chartMode">
  <option value="dailyTotals" selected>Denní součty (30 dní)</option>
  <option value="monthlyCaps">Měsíční přehled (6 měsíců)</option>
    </select>
    </div>
    <canvas id="chart" height="220"></canvas>
    <div style="margin-top:8px;color:var(--muted)">
      <span class="badge"><span class="dot cig"></span>Cigarety</span>
      <span class="badge" style="margin-left:10px"><span class="dot joint"></span>Jointy</span>
    </div>
  </section>

  <!-- Všechny záznamy -->
  <section class="card">
    <h3>Všechny záznamy</h3>
    <div id="groups"></div>
  </section>
</div>

<!-- Dialog zpětného záznamu -->
<dialog id="backfillDlg">
  <h3>Zpětný záznam</h3>
  <div class="btns" style="flex-direction:column;gap:6px">
    <select id="bfType">
      <option value="cig">Cigareta</option>
      <option value="joint">Joint</option>
    </select>
    <input id="bfDate" type="date">
    <input id="bfTime" type="time" step="60">
    <input id="bfNote" type="text" placeholder="poznámka (volitelné)">
  </div>
  <div class="btns" style="margin-top:10px">
    <button id="bfCancel">Zavřít</button>
    <button id="bfSave" class="primary">Uložit</button>
  </div>
</dialog>

<script>
/* ===== Pomocné ===== */
function pad(n){return String(n).padStart(2,'0')}
function dateKey(d=new Date()){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())}
function fmtDate(d){return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`}
function fmtTime(d){return pad(d.getHours())+':'+pad(d.getMinutes())}
function isoLocal(d){const tz=d.getTimezoneOffset();const t=new Date(d.getTime()-tz*60000);return t.toISOString().slice(0,19)}
function escapeHtml(s){return String(s||'').replace(/[&<>\"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m]))}

const STORAGE_KEY='smoketrack-entries-v1';
function loadAll(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ return []; } }
function saveAll(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
function genId(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}

let entries = loadAll(); // {id, ts, type:'cig'|'joint', note}

/* ===== UI refs ===== */
const groupsEl=document.getElementById('groups');
const todayBadge=document.getElementById('todayBadge');
const todayCig=document.getElementById('todayCig');
const todayJoint=document.getElementById('todayJoint');
const todayAll=document.getElementById('todayAll');

const btnCig=document.getElementById('btnCig');
const btnJoint=document.getElementById('btnJoint');
const undoBtn=document.getElementById('undoBtn');
const resetBtn=document.getElementById('resetBtn');

const backfillBtn=document.getElementById('backfillBtn');
const backfillDlg=document.getElementById('backfillDlg');
const bfType=document.getElementById('bfType');
const bfDate=document.getElementById('bfDate');
const bfTime=document.getElementById('bfTime');
const bfNote=document.getElementById('bfNote');

const chartMode=document.getElementById('chartMode');

function refreshHeader(){
  const now=new Date();
  const days=['Ne','Po','Út','St','Čt','Pá','So'];
  todayBadge.textContent=`${days[now.getDay()]} • ${dateKey(now)}`;
}

function addEntry(type, when=new Date(), note=''){
  entries.push({id:genId(), ts:isoLocal(when), type, note:note.trim()});
  saveAll(entries); render(); drawChart();
}

btnCig.addEventListener('click',()=>addEntry('cig'));
btnJoint.addEventListener('click',()=>addEntry('joint'));

undoBtn.addEventListener('click',()=>{
  entries.pop(); saveAll(entries); render(); drawChart();
});
resetBtn.addEventListener('click',()=>{
  if(confirm('Smazat všechny záznamy?')){
    localStorage.removeItem(STORAGE_KEY); entries=[]; render(); drawChart();
  }
});

backfillBtn.addEventListener('click',()=>{
  const now=new Date();
  bfDate.value=now.toISOString().slice(0,10);
  bfTime.value=`${pad(now.getHours())}:${pad(now.getMinutes())}`;
  bfType.value='cig'; bfNote.value='';
  backfillDlg.showModal();
});

document.getElementById('bfCancel').addEventListener('click',()=>backfillDlg.close());
document.getElementById('bfSave').addEventListener('click',()=>{
  const d=bfDate.value; const t=bfTime.value||'00:00';
  if(!d){alert('Zadej datum');return;}
  const [Y,M,D]=d.split('-').map(Number);
  const [H,Min]=t.split(':').map(Number);
  const when=new Date(Y,(M||1)-1,(D||1),H||0,Min||0);
  addEntry(bfType.value, when, bfNote.value);
  backfillDlg.close();
});

/* ===== Render tabulek + součty ===== */
function render(){
  refreshHeader();

  // --- Denní součty
  const today=dateKey(new Date());
  const todays=entries.filter(e=>e.ts.slice(0,10)===today);
  const cCig=todays.filter(e=>e.type==='cig').length;
  const cJoint=todays.filter(e=>e.type==='joint').length;
  todayCig.textContent=cCig; todayJoint.textContent=cJoint; todayAll.textContent=cCig+cJoint;

  // --- Měsíční součty
  const now=new Date();
  const monthPrefix = now.toISOString().slice(0,7); // YYYY-MM
  const monthEntries = entries.filter(e => e.ts.slice(0,7) === monthPrefix);
  const mCig = monthEntries.filter(e => e.type==='cig').length;
  const mJoint = monthEntries.filter(e => e.type==='joint').length;
  const mAll = mCig + mJoint;
  document.getElementById('monthCig').textContent = mCig;
  document.getElementById('monthJoint').textContent = mJoint;
  document.getElementById('monthAll').textContent = mAll;

  // --- Seskupení po dnech
  const byDay=new Map();
  entries.slice().sort((a,b)=>new Date(a.ts)-new Date(b.ts))
    .forEach(e=>{ const k=e.ts.slice(0,10); if(!byDay.has(k)) byDay.set(k,[]); byDay.get(k).push(e); });

  const ordered=[...byDay.keys()].sort((a,b)=>a<b?1:-1);
  groupsEl.innerHTML='';
  ordered.forEach(dayKey=>{
    const list=byDay.get(dayKey);
    const dt=new Date(list[0].ts);
    const cig=list.filter(e=>e.type==='cig').length;
    const joi=list.filter(e=>e.type==='joint').length;

    const det=document.createElement('details'); det.className='day'; if(dayKey===today) det.open=true;
    const sum=document.createElement('summary');
    sum.innerHTML = `<div>${fmtDate(dt)}</div><div class="badge"><span class="dot cig"></span>${cig} cig</div><div class="badge"><span class="dot joint"></span>${joi} joint</div>`;
    det.appendChild(sum);

    const tbl=document.createElement('table');
    tbl.innerHTML='<thead><tr><th>Čas</th><th>Typ</th><th>Poznámka</th><th></th></tr></thead><tbody></tbody>';
    const tb=tbl.querySelector('tbody');

    list.sort((a,b)=>new Date(a.ts)-new Date(b.ts)).forEach(e=>{
      const t=new Date(e.ts);
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${fmtTime(t)}</td><td>${e.type==='cig'?'Cigareta':'Joint'}</td><td>${escapeHtml(e.note)}</td><td><button class="ghost row-del" data-id="${e.id}">×</button></td>`;
      tb.appendChild(tr);
    });

    det.appendChild(tbl);
    groupsEl.appendChild(det);
  });
}

groupsEl.addEventListener('click',ev=>{
  const btn=ev.target.closest('.row-del'); if(!btn) return;
  const id=btn.getAttribute('data-id');
  if(confirm('Smazat tento záznam?')){
    entries=entries.filter(e=>e.id!==id); saveAll(entries); render(); drawChart();
  }
});

/* ===== Grafy ===== */
const chart=document.getElementById('chart'); const ctx=chart.getContext('2d');

/* --- nastavení „capů“ (max/den) pro měsíční režim --- */
const MAX_PER_DAY = { cig: 10, joint: 3 };

function getRangeDays(n=30){
  const out=[]; const now=new Date();
  for(let i=n-1;i>=0;i--){ const d=new Date(now.getFullYear(),now.getMonth(),now.getDate()-i); out.push(d); }
  return out;
}

function dailyTotals(n=30){
  const days=getRangeDays(n); const mapC=new Map(), mapJ=new Map();
  entries.forEach(e=>{
    const key=e.ts.slice(0,10);
    if(e.type==='cig') mapC.set(key,(mapC.get(key)||0)+1);
    else mapJ.set(key,(mapJ.get(key)||0)+1);
  });
  return days.map(d=>{
    const k=dateKey(d);
    return { label:`${pad(d.getDate())}.${pad(d.getMonth()+1)}`,
             cig:(mapC.get(k)||0), joint:(mapJ.get(k)||0) };
  });
}

/* --- pomocné pro měsíční agregaci --- */
function daysInMonth(y, m){ return new Date(y, m+1, 0).getDate(); } // m=0..11
function lastNMonths(n=6){
  const out=[]; const now=new Date();
  for(let i=n-1;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth()-i, 1); out.push({y:d.getFullYear(), m:d.getMonth()}); }
  return out;
}
function monthlyCapsData(n=6){
  const months=lastNMonths(n);
  const map=new Map();
  entries.forEach(e=>{ const k=e.ts.slice(0,7); if(!map.has(k)) map.set(k,[]); map.get(k).push(e); });
  return months.map(({y,m})=>{
    const key=`${y}-${pad(m+1)}`;
    const list=map.get(key)||[];
    const dpm=daysInMonth(y,m);
    const cigTot=list.filter(e=>e.type==='cig').length;
    const joiTot=list.filter(e=>e.type==='joint').length;
    const cigCap=dpm*MAX_PER_DAY.cig, joiCap=dpm*MAX_PER_DAY.joint;
    return {
      label:`${pad(m+1)}/${String(y).slice(-2)}`,
      cig:{ total:cigTot, cap:cigCap, ratio:cigCap?cigTot/cigCap:0 },
      joint:{ total:joiTot, cap:joiCap, ratio:joiCap?joiTot/joiCap:0 }
    };
  });
}

function drawChart(){
  const W=chart.width=chart.clientWidth, H=chart.height; ctx.clearRect(0,0,W,H);
  const left=40,right=10,top=12,bottom=28; const innerW=W-left-right, innerH=H-top-bottom;
  const mode=chartMode.value;

  const cigColor   = getComputedStyle(document.documentElement).getPropertyValue('--cig').trim()   || '#60a5fa';
  const jointColor = getComputedStyle(document.documentElement).getPropertyValue('--joint').trim() || '#22c55e';

  // osy
  ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(left, top); ctx.lineTo(left, H-bottom); ctx.lineTo(W-right, H-bottom); ctx.stroke();
  ctx.font='12px system-ui';

  if(mode==='dailyTotals'){
    const data=dailyTotals(30);
    const maxVal=Math.max(1, ...data.map(d=>Math.max(d.cig||0, d.joint||0)));
    const yMax=maxVal+1;

    // grid
    const steps=4;
    for(let i=0;i<=steps;i++){
      const y=top+innerH-(i/steps)*innerH, v=(i/steps)*yMax;
      ctx.strokeStyle='rgba(255,255,255,.12)'; ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(W-right,y); ctx.stroke();
      ctx.fillStyle='rgba(255,255,255,.75)'; ctx.textAlign='left'; ctx.fillText(v.toFixed(0), 6, y+4);
    }

    const xFor=i=>left+(data.length===1?0:(i/(data.length-1))*innerW);
    const yFor=v=>top+innerH-(v/yMax)*innerH;

    function drawLineFor(key,color){
      ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
      let pen=false;
      data.forEach((d,i)=>{
        const v=d[key]||0, x=xFor(i), y=yFor(v);
        if(v>0){ if(!pen){ctx.moveTo(x,y); pen=true;} else ctx.lineTo(x,y); } else pen=false;
      });
      ctx.stroke();
      ctx.fillStyle=color;
      data.forEach((d,i)=>{ const v=d[key]||0; if(v<=0) return; const x=xFor(i), y=yFor(v); ctx.beginPath(); ctx.arc(x,y,2.5,0,6.283); ctx.fill(); });
    }

    drawLineFor('cig',cigColor);
    drawLineFor('joint',jointColor);

    // X popisky
    ctx.fillStyle='rgba(255,255,255,.75)'; ctx.textAlign='center';
    const xStep=Math.max(1,Math.ceil(data.length/6));
    data.forEach((d,i)=>{ if(i%xStep===0 || i===data.length-1){ const x=left+(data.length===1?0:(i/(data.length-1))*innerW); ctx.fillText(d.label, x, H-8);} });
    return;
  }

  // ===== NOVÉ: Měsíční přehled (sloupce proti měsíčnímu maxu) =====
  if(mode==='monthlyCaps'){
    const data=monthlyCapsData(6);
    // Y v procentech
    const steps=4;
    for(let i=0;i<=steps;i++){
      const y=top+innerH-(i/steps)*innerH, v=(i/steps)*100;
      ctx.strokeStyle='rgba(255,255,255,.12)'; ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(W-right,y); ctx.stroke();
      ctx.fillStyle='rgba(255,255,255,.75)'; ctx.textAlign='left'; ctx.fillText(v.toFixed(0)+'%', 6, y+4);
    }

    const colW = innerW / data.length;                 // šířka slotu měsíce
    const barW = Math.min(26, (colW-16)/2);            // šířka jedné tyče
    const xForCol = i => left + i*colW + colW/2;
    function drawBar(xc, ratio, color){
      const r = Math.max(0, Math.min(1, ratio));
      const h = innerH * r;
      const x = xc - barW/2;
      const y = top + innerH - h;
      ctx.fillStyle=color; ctx.fillRect(x,y,barW,h);
    }

    data.forEach((m,i)=>{
      const cx=xForCol(i);
      // cig vlevo, joint vpravo
      drawBar(cx - (barW/2 + 4), m.cig.ratio, cigColor);
      drawBar(cx + (barW/2 + 4), m.joint.ratio, jointColor);

      // popisek měsíce
      ctx.fillStyle='rgba(255,255,255,.85)'; ctx.textAlign='center';
      ctx.fillText(m.label, cx, H-8);

      // malé číslo nad sloupci (aktuální hodnoty)
      ctx.font='11px system-ui'; ctx.fillStyle='rgba(255,255,255,.65)';
      const topY = Math.min(
        top + innerH - innerH * m.cig.ratio,
        top + innerH - innerH * m.joint.ratio
      ) - 4;
      ctx.fillText(`${m.cig.total} | ${m.joint.total}`, cx, Math.max(top+10, topY));
      ctx.font='12px system-ui';
    });
    return;
  }
}

/* ===== Init ===== */
let rAf; window.addEventListener('resize',()=>{ cancelAnimationFrame(rAf); rAf=requestAnimationFrame(drawChart); });
chartMode.addEventListener('change', drawChart);

function renderAll(){ render(); drawChart(); }
renderAll();
let quickDone = false;

function handleQuick() {
  if (quickDone) return;
  const params = new URLSearchParams(window.location.search);
  const quick = params.get('quick');
  if (!quick) return;

  const targetId =
    quick === 'cig' ? 'btnCig' :
    quick === 'joint' ? 'btnJoint' :
    null;
  if (!targetId) return;

  const btn = document.getElementById(targetId);
  if (btn) {
    btn.click();
    quickDone = true; // ZABRÁNÍ opakování
    console.log("Quick logged:", quick);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  setTimeout(handleQuick, 120);
});

</script>
</body>
</html>
